# å®¡è®¡ç»„ä»¶è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»toolkitæ¨¡å—ä¸­å®¡è®¡ç»„ä»¶çš„è®¾è®¡æ€è·¯ã€æ¶æ„ç»„æˆå’Œä½¿ç”¨æ–¹æ³•ã€‚å®¡è®¡ç»„ä»¶æ˜¯ä¼ä¸šåº”ç”¨ä¸­å¿…ä¸å¯å°‘çš„å®‰å…¨åˆè§„ç»„ä»¶ï¼Œç”¨äºè®°å½•å’Œè¿½è¸ªç³»ç»Ÿä¸­çš„å…³é”®æ“ä½œå’Œäº‹ä»¶ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

- **å®Œæ•´æ€§** - è®°å½•æ‰€æœ‰å…³é”®ä¸šåŠ¡æ“ä½œå’Œå®‰å…¨äº‹ä»¶
- **ä¸å¯ç¯¡æ”¹** - å®¡è®¡æ—¥å¿—ä¸€æ—¦ç”Ÿæˆä¸å¯ä¿®æ”¹
- **å¯è¿½æº¯** - èƒ½å¤Ÿè¿½è¸ªæ“ä½œçš„å®Œæ•´é“¾è·¯å’Œæ—¶é—´çº¿
- **é«˜æ€§èƒ½** - å¼‚æ­¥è®°å½•ï¼Œä¸å½±å“ä¸šåŠ¡æ€§èƒ½
- **åˆè§„æ€§** - æ»¡è¶³SOXã€GDPRç­‰æ³•è§„è¦æ±‚
- **å¯æ‰©å±•** - æ”¯æŒè‡ªå®šä¹‰å®¡è®¡è§„åˆ™å’Œå­˜å‚¨

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. ç»„ä»¶å±‚æ¬¡ç»“æ„

```
å®¡è®¡ç»„ä»¶
â”œâ”€â”€ æ ¸å¿ƒå±‚ (Core)
â”‚   â”œâ”€â”€ AuditEvent - å®¡è®¡äº‹ä»¶å®ä½“
â”‚   â”œâ”€â”€ AuditEventType - äº‹ä»¶ç±»å‹æšä¸¾
â”‚   â”œâ”€â”€ AuditResult - å®¡è®¡ç»“æœæšä¸¾
â”‚   â””â”€â”€ AuditQuery - æŸ¥è¯¢æ¡ä»¶
â”œâ”€â”€ æœåŠ¡å±‚ (Service)
â”‚   â”œâ”€â”€ AuditService - å®¡è®¡æœåŠ¡æ¥å£
â”‚   â””â”€â”€ DefaultAuditService - é»˜è®¤å®ç°
â”œâ”€â”€ æ³¨è§£å±‚ (Annotation)
â”‚   â”œâ”€â”€ @Auditable - å®¡è®¡æ³¨è§£
â”‚   â””â”€â”€ AuditAspect - å®¡è®¡åˆ‡é¢
â”œâ”€â”€ å·¥å…·å±‚ (Utils)
â”‚   â””â”€â”€ AuditUtils - å®¡è®¡å·¥å…·ç±»
â””â”€â”€ é…ç½®å±‚ (Config)
    â””â”€â”€ AuditConfig - å®¡è®¡é…ç½®
```

### 2. æ•°æ®æµæ¶æ„

```
ä¸šåŠ¡æ“ä½œ â†’ @Auditableæ³¨è§£ â†’ AuditAspectåˆ‡é¢ â†’ AuditEventåˆ›å»º â†’ AuditServiceä¿å­˜ â†’ å­˜å‚¨ä»‹è´¨
     â†“                                                                      â†“
  AuditUtilså·¥å…·ç±» â†’ æ‰‹åŠ¨åˆ›å»ºAuditEvent â†’ AuditServiceä¿å­˜ â†’ å­˜å‚¨ä»‹è´¨
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. å®¡è®¡äº‹ä»¶ç±»å‹

```java
public enum AuditEventType {
    AUTHENTICATION,      // ç”¨æˆ·è®¤è¯äº‹ä»¶
    AUTHORIZATION,       // ç”¨æˆ·æˆæƒäº‹ä»¶  
    DATA_OPERATION,      // æ•°æ®æ“ä½œäº‹ä»¶
    SYSTEM_CONFIG,       // ç³»ç»Ÿé…ç½®äº‹ä»¶
    SECURITY,           // å®‰å…¨äº‹ä»¶
    BUSINESS_OPERATION, // ä¸šåŠ¡æ“ä½œäº‹ä»¶
    FILE_OPERATION,     // æ–‡ä»¶æ“ä½œäº‹ä»¶
    API_CALL,          // APIè°ƒç”¨äº‹ä»¶
    SCHEDULED_TASK,    // å®šæ—¶ä»»åŠ¡äº‹ä»¶
    SYSTEM_ERROR       // ç³»ç»Ÿå¼‚å¸¸äº‹ä»¶
}
```

### 2. å®¡è®¡æ³¨è§£

```java
@Auditable(
    operation = "CREATE_USER",
    description = "åˆ›å»ºç”¨æˆ·",
    eventType = AuditEventType.DATA_OPERATION,
    resourceType = "USER",
    includeParameters = true,
    includeResult = false,
    async = true,
    businessKey = "#request.username"
)
public User createUser(CreateUserRequest request) {
    // ä¸šåŠ¡é€»è¾‘
}
```

### 3. å®¡è®¡å·¥å…·ç±»

```java
// è®°å½•ç™»å½•äº‹ä»¶
AuditUtils.recordLogin(userId, username, clientIp, success);

// è®°å½•æ•°æ®æ“ä½œ
AuditUtils.recordCreate(userId, "USER", userId, userData, "åˆ›å»ºç”¨æˆ·");

// ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼
AuditUtils.builder()
    .userId(userId)
    .eventType(AuditEventType.DATA_OPERATION)
    .operation("UPDATE_USER")
    .resourceType("USER")
    .resourceId(userId)
    .beforeData(oldUser)
    .afterData(newUser)
    .description("æ›´æ–°ç”¨æˆ·ä¿¡æ¯")
    .success()
    .save();
```

## ğŸ“Š å®¡è®¡å†…å®¹è§„èŒƒ

### 1. è®¤è¯å®¡è®¡

```java
// ç™»å½•æˆåŠŸ
AuditUtils.recordLogin("user123", "å¼ ä¸‰", "192.168.1.100", true);

// ç™»å½•å¤±è´¥
AuditUtils.recordSecurityEvent("user123", "LOGIN_FAILED", 
    "å¯†ç é”™è¯¯", "192.168.1.100", false);

// å¯†ç é‡ç½®
AuditUtils.recordSecurityEvent("user123", "PASSWORD_RESET", 
    "ç®¡ç†å‘˜é‡ç½®å¯†ç ", "192.168.1.101", true);
```

### 2. æ•°æ®æ“ä½œå®¡è®¡

```java
@Service
public class UserService {
    
    @Auditable(operation = "CREATE_USER", eventType = AuditEventType.DATA_OPERATION)
    public User createUser(CreateUserRequest request) {
        // åˆ›å»ºç”¨æˆ·é€»è¾‘
    }
    
    @Auditable(operation = "UPDATE_USER", 
               businessKey = "#id",
               includeParameters = true)
    public User updateUser(Long id, UpdateUserRequest request) {
        // æ›´æ–°ç”¨æˆ·é€»è¾‘
    }
    
    @Auditable(operation = "DELETE_USER", 
               resourceType = "USER",
               businessKey = "#id")
    public void deleteUser(Long id) {
        // åˆ é™¤ç”¨æˆ·é€»è¾‘
    }
}
```

### 3. æƒé™å˜æ›´å®¡è®¡

```java
// è§’è‰²åˆ†é…
AuditUtils.recordPermissionChange(adminUserId, targetUserId, 
    "GRANT_ROLE", "ADMIN", "åˆ†é…ç®¡ç†å‘˜è§’è‰²");

// æƒé™æ’¤é”€
AuditUtils.recordPermissionChange(adminUserId, targetUserId,
    "REVOKE_PERMISSION", "USER_DELETE", "æ’¤é”€åˆ é™¤ç”¨æˆ·æƒé™");
```

### 4. ç³»ç»Ÿé…ç½®å®¡è®¡

```java
// é…ç½®å˜æ›´
AuditUtils.recordConfigChange(adminUserId, "max_login_attempts", 
    "3", "5", "ä¿®æ”¹æœ€å¤§ç™»å½•å°è¯•æ¬¡æ•°");

// ç³»ç»Ÿå‚æ•°è°ƒæ•´
@Auditable(operation = "UPDATE_CONFIG", eventType = AuditEventType.SYSTEM_CONFIG)
public void updateSystemConfig(String key, String value) {
    // é…ç½®æ›´æ–°é€»è¾‘
}
```

### 5. æ–‡ä»¶æ“ä½œå®¡è®¡

```java
// æ–‡ä»¶ä¸Šä¼ 
AuditUtils.recordFileOperation(userId, "UPLOAD", "contract.pdf",
    "/uploads/contracts/", 1024000, "ä¸Šä¼ åˆåŒæ–‡ä»¶");

// æ–‡ä»¶ä¸‹è½½
@Auditable(operation = "DOWNLOAD_FILE", eventType = AuditEventType.FILE_OPERATION)
public ResponseEntity<Resource> downloadFile(String filename) {
    // æ–‡ä»¶ä¸‹è½½é€»è¾‘
}
```

## ğŸ”§ é…ç½®å’Œä½¿ç”¨

### 1. Spring Booté…ç½®

```properties
# application.properties
audit.enabled=true
audit.json.enabled=true
audit.async.enabled=true
audit.thread-pool.core-size=2
audit.thread-pool.max-size=4
audit.thread-pool.queue-capacity=1000
```

### 2. å¯ç”¨å®¡è®¡ç»„ä»¶

```java
@SpringBootApplication
@ComponentScan(basePackages = {"com.yourpackage", "com.abc.web.support"})
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

### 3. è‡ªå®šä¹‰å®¡è®¡å­˜å‚¨

```java
@Service
@Primary
public class DatabaseAuditService implements AuditService {
    
    @Autowired
    private AuditEventRepository repository;
    
    @Override
    public void saveAuditEvent(AuditEvent event) {
        // ä¿å­˜åˆ°æ•°æ®åº“
        AuditEventEntity entity = convertToEntity(event);
        repository.save(entity);
    }
    
    @Override
    @Async("auditExecutor")
    public CompletableFuture<Void> saveAuditEventAsync(AuditEvent event) {
        return CompletableFuture.runAsync(() -> saveAuditEvent(event));
    }
    
    // å…¶ä»–æ–¹æ³•å®ç°...
}
```

## ğŸ“ˆ æŸ¥è¯¢å’Œåˆ†æ

### 1. å®¡è®¡æ—¥å¿—æŸ¥è¯¢

```java
@RestController
@RequestMapping("/api/audit")
public class AuditController {
    
    @Autowired
    private AuditService auditService;
    
    @PostMapping("/query")
    public Response<Pagination<AuditEvent>> queryAuditEvents(@RequestBody AuditQuery query) {
        List<AuditEvent> events = auditService.queryAuditEvents(query);
        long total = auditService.countAuditEvents(query);
        
        Pagination<AuditEvent> result = Pagination.of(events, total, 
                query.getPageNum(), query.getPageSize());
        return Response.success(result);
    }
    
    @GetMapping("/user/{userId}")
    public Response<List<AuditEvent>> getUserAuditEvents(@PathVariable String userId,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startTime,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endTime) {
        
        List<AuditEvent> events = auditService.queryByUserId(userId, startTime, endTime);
        return Response.success(events);
    }
}
```

### 2. å®¡è®¡ç»Ÿè®¡åˆ†æ

```java
@Service
public class AuditAnalysisService {
    
    public Map<String, Long> getOperationStatistics(LocalDateTime startTime, LocalDateTime endTime) {
        AuditQuery query = new AuditQuery();
        query.setStartTime(startTime);
        query.setEndTime(endTime);
        
        List<AuditEvent> events = auditService.queryAuditEvents(query);
        
        return events.stream()
                .collect(Collectors.groupingBy(
                    AuditEvent::getOperation,
                    Collectors.counting()
                ));
    }
    
    public Map<String, Long> getUserActivityStatistics(String userId, LocalDateTime startTime, LocalDateTime endTime) {
        List<AuditEvent> events = auditService.queryByUserId(userId, startTime, endTime);
        
        return events.stream()
                .collect(Collectors.groupingBy(
                    event -> event.getEventType().name(),
                    Collectors.counting()
                ));
    }
}
```

## ğŸ” å®‰å…¨å’Œåˆè§„

### 1. æ•°æ®ä¿æŠ¤

```java
// æ•æ„Ÿæ•°æ®è„±æ•
@Auditable(operation = "UPDATE_USER", 
           sensitiveParams = {1}, // ç¬¬äºŒä¸ªå‚æ•°åŒ…å«å¯†ç 
           includeParameters = true)
public void updateUserPassword(Long userId, String newPassword) {
    // å¯†ç æ›´æ–°é€»è¾‘
}
```

### 2. å®¡è®¡æ—¥å¿—å®Œæ•´æ€§

```java
// å®¡è®¡æ—¥å¿—ç­¾åéªŒè¯
@Component
public class AuditIntegrityService {
    
    public String generateSignature(AuditEvent event) {
        // ç”Ÿæˆå®¡è®¡äº‹ä»¶ç­¾å
        String data = event.getEventId() + event.getUserId() + 
                     event.getOperation() + event.getEventTime();
        return DigestUtils.sha256Hex(data + SECRET_KEY);
    }
    
    public boolean verifyIntegrity(AuditEvent event, String signature) {
        String expectedSignature = generateSignature(event);
        return expectedSignature.equals(signature);
    }
}
```

### 3. æ•°æ®ä¿ç•™ç­–ç•¥

```java
@Component
@Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
public class AuditCleanupTask {
    
    @Autowired
    private AuditService auditService;
    
    @Value("${audit.retention.days:365}")
    private int retentionDays;
    
    public void cleanupExpiredAuditEvents() {
        LocalDateTime cutoffTime = LocalDateTime.now().minusDays(retentionDays);
        int cleanedCount = auditService.cleanupExpiredAuditEvents(cutoffTime);
        
        log.info("æ¸…ç†è¿‡æœŸå®¡è®¡æ—¥å¿—å®Œæˆï¼Œæ¸…ç†æ•°é‡: {}", cleanedCount);
    }
}
```

## ğŸ§ª æµ‹è¯•æ”¯æŒ

### 1. å®¡è®¡æµ‹è¯•å·¥å…·

```java
@TestComponent
public class AuditTestUtils {
    
    @Autowired
    private AuditService auditService;
    
    public void clearAuditEvents() {
        // æ¸…ç†æµ‹è¯•æ•°æ®
    }
    
    public List<AuditEvent> getAuditEvents(String userId) {
        AuditQuery query = new AuditQuery();
        query.setUserId(userId);
        return auditService.queryAuditEvents(query);
    }
    
    public void assertAuditEventExists(String userId, String operation) {
        List<AuditEvent> events = getAuditEvents(userId);
        boolean exists = events.stream()
                .anyMatch(event -> operation.equals(event.getOperation()));
        
        assertTrue("å®¡è®¡äº‹ä»¶ä¸å­˜åœ¨: " + operation, exists);
    }
}
```

### 2. å®¡è®¡å•å…ƒæµ‹è¯•

```java
@SpringBootTest
@Transactional
class AuditServiceTest {
    
    @Autowired
    private AuditService auditService;
    
    @Autowired
    private AuditTestUtils auditTestUtils;
    
    @Test
    void testSaveAuditEvent() {
        // given
        AuditEvent event = AuditEvent.create()
                .setUserId("testUser")
                .setOperation("TEST_OPERATION")
                .setEventType(AuditEventType.DATA_OPERATION)
                .success();
        
        // when
        auditService.saveAuditEvent(event);
        
        // then
        auditTestUtils.assertAuditEventExists("testUser", "TEST_OPERATION");
    }
    
    @Test
    void testAuditAnnotation() {
        // æµ‹è¯•@Auditableæ³¨è§£åŠŸèƒ½
    }
}
```

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### 1. å®¡è®¡ç›‘æ§æŒ‡æ ‡

```java
@Component
public class AuditMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter auditEventCounter;
    private final Timer auditSaveTimer;
    
    public AuditMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.auditEventCounter = Counter.builder("audit.events.total")
                .register(meterRegistry);
        this.auditSaveTimer = Timer.builder("audit.save.duration")
                .register(meterRegistry);
    }
    
    public void recordAuditEvent(AuditEventType eventType) {
        auditEventCounter.increment(Tags.of("type", eventType.name()));
    }
    
    public void recordSaveDuration(Duration duration) {
        auditSaveTimer.record(duration);
    }
}
```

### 2. å®‰å…¨å‘Šè­¦

```java
@Component
public class SecurityAlertService {
    
    @EventListener
    public void handleFailedLoginAttempts(AuditEvent event) {
        if (AuditEventType.AUTHENTICATION.equals(event.getEventType()) &&
            "LOGIN_FAILED".equals(event.getOperation())) {
            
            // æ£€æŸ¥æ˜¯å¦è¿ç»­å¤±è´¥ç™»å½•
            checkMultipleFailedLogins(event.getUserId(), event.getClientIp());
        }
    }
    
    private void checkMultipleFailedLogins(String userId, String clientIp) {
        // æŸ¥è¯¢æœ€è¿‘çš„å¤±è´¥ç™»å½•è®°å½•
        // å¦‚æœè¶…è¿‡é˜ˆå€¼ï¼Œå‘é€å‘Šè­¦
    }
}
```

## ğŸ“š æœ€ä½³å®è·µ

### 1. å®¡è®¡ç­–ç•¥

- **å…³é”®æ“ä½œå¿…å®¡** - æ‰€æœ‰æ¶‰åŠæ•°æ®ä¿®æ”¹çš„æ“ä½œå¿…é¡»å®¡è®¡
- **å¼‚æ­¥è®°å½•** - ä½¿ç”¨å¼‚æ­¥æ–¹å¼è®°å½•å®¡è®¡æ—¥å¿—ï¼Œé¿å…å½±å“ä¸šåŠ¡æ€§èƒ½
- **æ•æ„Ÿæ•°æ®è„±æ•** - å¯¹å¯†ç ã€èº«ä»½è¯ç­‰æ•æ„Ÿä¿¡æ¯è¿›è¡Œè„±æ•å¤„ç†
- **å®šæœŸæ¸…ç†** - æ ¹æ®æ³•è§„è¦æ±‚è®¾ç½®åˆç†çš„æ•°æ®ä¿ç•™æœŸé™

### 2. æ€§èƒ½ä¼˜åŒ–

- **æ‰¹é‡å†™å…¥** - å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œä½¿ç”¨æ‰¹é‡å†™å…¥æé«˜æ€§èƒ½
- **åˆ†è¡¨å­˜å‚¨** - æŒ‰æ—¶é—´æˆ–ä¸šåŠ¡ç»´åº¦åˆ†è¡¨å­˜å‚¨å®¡è®¡æ•°æ®
- **ç´¢å¼•ä¼˜åŒ–** - ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºç«‹åˆé€‚çš„ç´¢å¼•
- **å¼‚æ­¥å¤„ç†** - ä½¿ç”¨ä¸“ç”¨çº¿ç¨‹æ± å¤„ç†å®¡è®¡ä»»åŠ¡

### 3. åˆè§„è¦æ±‚

- **ä¸å¯ç¯¡æ”¹** - å®¡è®¡æ—¥å¿—ä¸€æ—¦ç”Ÿæˆä¸å…è®¸ä¿®æ”¹
- **å®Œæ•´è¿½æº¯** - èƒ½å¤Ÿå®Œæ•´è¿½è¸ªä¸šåŠ¡æ“ä½œçš„å‰åçŠ¶æ€
- **è®¿é—®æ§åˆ¶** - ä¸¥æ ¼æ§åˆ¶å®¡è®¡æ—¥å¿—çš„è®¿é—®æƒé™
- **å®šæœŸå¤‡ä»½** - å®šæœŸå¤‡ä»½å®¡è®¡æ•°æ®ï¼Œç¡®ä¿æ•°æ®å®‰å…¨

## ğŸ“š å‚è€ƒèµ„æ–™

- [SOXåˆè§„è¦æ±‚](https://www.sec.gov/about/laws/soa2002.pdf)
- [GDPRæ•°æ®ä¿æŠ¤æ³•è§„](https://gdpr-info.eu/)
- [Spring AOPæ–‡æ¡£](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop)
- [ä¼ä¸šåº”ç”¨å®¡è®¡æœ€ä½³å®è·µ](https://owasp.org/www-community/controls/Audit_Logging)