# ä¼ä¸šåº”ç”¨å¼€å‘æœ€ä½³å®è·µæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†ä½¿ç”¨toolkitæ¨¡å—è¿›è¡Œä¼ä¸šåº”ç”¨å¼€å‘çš„æœ€ä½³å®è·µï¼Œæ¶µç›–æ¶æ„è®¾è®¡ã€ç¼–ç è§„èŒƒã€æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨å®è·µç­‰æ–¹é¢çš„ç»éªŒå’Œå»ºè®®ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡æœ€ä½³å®è·µ

### 1. åˆ†å±‚æ¶æ„åŸåˆ™

```
Controller å±‚ (è¡¨ç°å±‚)
â”œâ”€â”€ å‚æ•°éªŒè¯
â”œâ”€â”€ æƒé™æ£€æŸ¥  
â”œâ”€â”€ å¼‚å¸¸å¤„ç†
â””â”€â”€ å“åº”å°è£…

Service å±‚ (ä¸šåŠ¡å±‚)
â”œâ”€â”€ ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ äº‹åŠ¡ç®¡ç†
â”œâ”€â”€ ä¸šåŠ¡éªŒè¯
â””â”€â”€ æ•°æ®è½¬æ¢

Repository å±‚ (æ•°æ®å±‚)
â”œâ”€â”€ æ•°æ®è®¿é—®
â”œâ”€â”€ æŸ¥è¯¢ä¼˜åŒ–
â””â”€â”€ æ•°æ®ä¸€è‡´æ€§
```

### 2. ç»Ÿä¸€å“åº”æ ¼å¼

```java
// ç»Ÿä¸€ä½¿ç”¨ResponseåŒ…è£…å“åº”
@RestController
public class UserController {
    
    @GetMapping("/users/{id}")
    public Response<UserDTO> getUser(@PathVariable Long id) {
        UserDTO user = userService.getUser(id);
        return Response.success(user);
    }
    
    @PostMapping("/users/query")
    public Response<Pagination<UserDTO>> queryUsers(@RequestBody UserQuery query) {
        Pagination<UserDTO> result = userService.queryUsers(query);
        return Response.success(result);
    }
}
```

### 3. å¼‚å¸¸å¤„ç†è§„èŒƒ

```java
// Serviceå±‚ä½¿ç”¨æ–­è¨€å’Œå¼‚å¸¸å·¥å…·
@Service
public class UserService {
    
    public UserDTO getUser(Long id) {
        // å‚æ•°éªŒè¯
        ExceptionUtils.requireNonNull(id, "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        
        // ä¸šåŠ¡é€»è¾‘
        User user = userRepository.findById(id);
        ExceptionUtils.throwBusinessIf(user == null, 
                I18nCommonExceptionCode.DATA_NOT_FOUND);
        
        return userConverter.toDTO(user);
    }
}
```

## ğŸ’» ç¼–ç è§„èŒƒæœ€ä½³å®è·µ

### 1. ç±»å’Œæ–¹æ³•è®¾è®¡

```java
// å•ä¸€èŒè´£åŸåˆ™
@Service
public class UserService {
    
    // æ–¹æ³•åŠŸèƒ½å•ä¸€ã€èŒè´£æ˜ç¡®
    public UserDTO createUser(UserCreateRequest request) {
        validateUserRequest(request);
        User user = buildUserFromRequest(request);
        User savedUser = saveUser(user);
        publishUserCreatedEvent(savedUser);
        return userConverter.toDTO(savedUser);
    }
    
    private void validateUserRequest(UserCreateRequest request) {
        // éªŒè¯é€»è¾‘
    }
    
    private User buildUserFromRequest(UserCreateRequest request) {
        // æ„å»ºé€»è¾‘
    }
}
```

### 2. å‚æ•°éªŒè¯è§„èŒƒ

```java
// åˆ†å±‚éªŒè¯ï¼šControlleråŸºç¡€éªŒè¯ + Serviceä¸šåŠ¡éªŒè¯
@RestController
public class UserController {
    
    @PostMapping("/users")
    public Response<UserDTO> createUser(@Valid @RequestBody UserCreateRequest request) {
        // Controllerå±‚åªåšåŸºç¡€éªŒè¯ï¼Œä¸šåŠ¡éªŒè¯åœ¨Serviceå±‚
        UserDTO user = userService.createUser(request);
        return Response.success(user);
    }
}

@Service
public class UserService {
    
    public UserDTO createUser(UserCreateRequest request) {
        // Serviceå±‚åšä¸šåŠ¡éªŒè¯
        ExceptionUtils.requireNonNull(request, "è¯·æ±‚ä¸èƒ½ä¸ºç©º");
        ExceptionUtils.throwBusinessIf(
                userRepository.existsByUsername(request.getUsername()),
                I18nCommonExceptionCode.USER_ALREADY_EXISTS
        );
        // ä¸šåŠ¡é€»è¾‘...
    }
}
```

### 3. æ•°æ®è½¬æ¢è§„èŒƒ

```java
// ä½¿ç”¨MapStructè¿›è¡Œå¯¹è±¡è½¬æ¢
@Mapper(componentModel = "spring")
public interface UserConverter {
    
    UserDTO toDTO(User user);
    
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "createTime", ignore = true)
    User toEntity(UserCreateRequest request);
    
    List<UserDTO> toDTOList(List<User> users);
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```java
// ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢é¿å…å¤§æ•°æ®é‡æŸ¥è¯¢
@Service
public class UserService {
    
    public Pagination<UserDTO> queryUsers(UserQuery query) {
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        QueryWrapper<User> wrapper = buildQueryWrapper(query);
        
        // åˆ†é¡µæŸ¥è¯¢
        Page<User> page = new Page<>(query.getPageNum(), query.getPageSize());
        Page<User> result = userRepository.selectPage(page, wrapper);
        
        // è½¬æ¢ä¸ºDTO
        List<UserDTO> userDTOs = userConverter.toDTOList(result.getRecords());
        
        return Pagination.of(userDTOs, result.getTotal(), 
                query.getPageNum(), query.getPageSize());
    }
}
```

### 2. ç¼“å­˜ä½¿ç”¨è§„èŒƒ

```java
// åˆç†ä½¿ç”¨ç¼“å­˜
@Service
public class UserService {
    
    @Cacheable(value = "users", key = "#id")
    public UserDTO getUser(Long id) {
        User user = userRepository.findById(id);
        ExceptionUtils.throwBusinessIf(user == null, 
                I18nCommonExceptionCode.DATA_NOT_FOUND);
        return userConverter.toDTO(user);
    }
    
    @CacheEvict(value = "users", key = "#user.id")
    public UserDTO updateUser(UserUpdateRequest request) {
        // æ›´æ–°é€»è¾‘
    }
}
```

### 3. å¼‚æ­¥å¤„ç†

```java
// è€—æ—¶æ“ä½œä½¿ç”¨å¼‚æ­¥å¤„ç†
@Service
public class NotificationService {
    
    @Async
    public CompletableFuture<Void> sendNotificationAsync(Long userId, String message) {
        // å¼‚æ­¥å‘é€é€šçŸ¥
        try {
            sendNotification(userId, message);
            return CompletableFuture.completedFuture(null);
        } catch (Exception e) {
            return CompletableFuture.failedFuture(e);
        }
    }
}
```

## ğŸ”’ å®‰å…¨å®è·µæœ€ä½³å®è·µ

### 1. è¾“å…¥éªŒè¯

```java
// ä¸¥æ ¼çš„è¾“å…¥éªŒè¯
@RestController
public class UserController {
    
    @PostMapping("/users")
    public Response<UserDTO> createUser(@Valid @RequestBody UserCreateRequest request) {
        // 1. åŸºç¡€éªŒè¯ï¼ˆBean Validationï¼‰
        // 2. ä¸šåŠ¡éªŒè¯åœ¨Serviceå±‚
        // 3. SQLæ³¨å…¥é˜²æŠ¤ï¼ˆä½¿ç”¨MyBatiså‚æ•°åŒ–æŸ¥è¯¢ï¼‰
        // 4. XSSé˜²æŠ¤ï¼ˆè¾“å‡ºæ—¶è½¬ä¹‰ï¼‰
        
        UserDTO user = userService.createUser(request);
        return Response.success(user);
    }
}
```

### 2. æƒé™æ§åˆ¶

```java
// å¤šå±‚æƒé™æ§åˆ¶
@RestController
@RequestMapping("/api/admin")
@PreAuthorize("hasRole('ADMIN')")  // å…¨å±€æƒé™
public class AdminController {
    
    @GetMapping("/users/{id}")
    @PreAuthorize("hasPermission(#id, 'USER', 'READ')")  // èµ„æºæƒé™
    public Response<UserDTO> getUser(@PathVariable Long id) {
        UserDTO user = userService.getUser(id);
        return Response.success(user);
    }
}
```

### 3. æ•æ„Ÿæ•°æ®å¤„ç†

```java
// æ•æ„Ÿæ•°æ®åŠ å¯†å’Œè„±æ•
@Entity
public class User {
    
    @Column(name = "password")
    @Convert(converter = PasswordConverter.class)  // å¯†ç åŠ å¯†å­˜å‚¨
    private String password;
    
    @Column(name = "mobile") 
    @Convert(converter = MobileConverter.class)    // æ‰‹æœºå·åŠ å¯†å­˜å‚¨
    private String mobile;
    
    // DTOä¸­æ•æ„Ÿå­—æ®µè„±æ•
    @JsonSerialize(using = SensitiveDataSerializer.class)
    public String getMobile() {
        return mobile;
    }
}
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—æœ€ä½³å®è·µ

### 1. æ“ä½œæ—¥å¿—

```java
// å…³é”®æ“ä½œè®°å½•å®¡è®¡æ—¥å¿—
@Service
public class UserService {
    
    @Auditable(operation = "CREATE_USER")
    public UserDTO createUser(UserCreateRequest request) {
        try {
            User user = userConverter.toEntity(request);
            User savedUser = userRepository.save(user);
            
            log.info("ç”¨æˆ·åˆ›å»ºæˆåŠŸ - ç”¨æˆ·ID: {}, ç”¨æˆ·å: {}", 
                    savedUser.getId(), savedUser.getUsername());
            
            return userConverter.toDTO(savedUser);
        } catch (Exception e) {
            log.error("ç”¨æˆ·åˆ›å»ºå¤±è´¥ - ç”¨æˆ·å: {}, é”™è¯¯: {}", 
                    request.getUsername(), e.getMessage(), e);
            throw e;
        }
    }
}
```

### 2. æ€§èƒ½ç›‘æ§

```java
// å…³é”®æ¥å£æ€§èƒ½ç›‘æ§
@RestController
public class UserController {
    
    @Timed(name = "user.query", description = "ç”¨æˆ·æŸ¥è¯¢æ¥å£è€—æ—¶")
    @GetMapping("/users/query")
    public Response<Pagination<UserDTO>> queryUsers(@RequestBody UserQuery query) {
        Pagination<UserDTO> result = userService.queryUsers(query);
        return Response.success(result);
    }
}
```

## ğŸ§ª æµ‹è¯•æœ€ä½³å®è·µ

### 1. å•å…ƒæµ‹è¯•

```java
// å…¨é¢çš„å•å…ƒæµ‹è¯•
@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private UserConverter userConverter;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void createUser_Success() {
        // given
        UserCreateRequest request = buildUserCreateRequest();
        User user = buildUser();
        UserDTO expectedDTO = buildUserDTO();
        
        when(userRepository.existsByUsername(request.getUsername())).thenReturn(false);
        when(userConverter.toEntity(request)).thenReturn(user);
        when(userRepository.save(user)).thenReturn(user);
        when(userConverter.toDTO(user)).thenReturn(expectedDTO);
        
        // when
        UserDTO result = userService.createUser(request);
        
        // then
        assertThat(result).isEqualTo(expectedDTO);
        verify(userRepository).save(user);
    }
    
    @Test
    void createUser_ThrowsException_WhenUsernameExists() {
        // given
        UserCreateRequest request = buildUserCreateRequest();
        when(userRepository.existsByUsername(request.getUsername())).thenReturn(true);
        
        // when & then
        assertThatThrownBy(() -> userService.createUser(request))
                .isInstanceOf(BusinessException.class)
                .hasMessageContaining("ç”¨æˆ·åå·²å­˜åœ¨");
    }
}
```

### 2. é›†æˆæµ‹è¯•

```java
// å…³é”®åŠŸèƒ½é›†æˆæµ‹è¯•
@SpringBootTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@Transactional
class UserControllerIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @Test
    void createUser_Success() throws Exception {
        // given
        UserCreateRequest request = buildUserCreateRequest();
        
        // when & then
        mockMvc.perform(post("/api/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(0))
                .andExpect(jsonPath("$.data.username").value(request.getUsername()));
    }
}
```

## ğŸ“¦ éƒ¨ç½²å’Œè¿ç»´æœ€ä½³å®è·µ

### 1. é…ç½®ç®¡ç†

```yaml
# application.yml - ç¯å¢ƒç›¸å…³é…ç½®
spring:
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  datasource:
    url: ${DB_URL:jdbc:mysql://localhost:3306/toolkit}
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:password}

# æ•æ„Ÿé…ç½®ä½¿ç”¨ç¯å¢ƒå˜é‡
app:
  jwt:
    secret-key: ${JWT_SECRET_KEY}
    token-validity-in-seconds: ${JWT_TOKEN_VALIDITY:3600}
```

### 2. å¥åº·æ£€æŸ¥

```java
// è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    
    @Autowired
    private DataSource dataSource;
    
    @Override
    public Health health() {
        try (Connection connection = dataSource.getConnection()) {
            if (connection.isValid(1)) {
                return Health.up()
                        .withDetail("database", "Available")
                        .build();
            }
        } catch (Exception e) {
            return Health.down()
                    .withDetail("database", "Unavailable")
                    .withException(e)
                    .build();
        }
        return Health.down().build();
    }
}
```

## ğŸ“š æ€»ç»“

éµå¾ªä»¥ä¸Šæœ€ä½³å®è·µå¯ä»¥ï¼š

1. **æé«˜ä»£ç è´¨é‡** - è§„èŒƒçš„ç¼–ç é£æ ¼å’Œè®¾è®¡æ¨¡å¼
2. **å¢å¼ºç³»ç»Ÿå®‰å…¨** - å¤šå±‚å®‰å…¨é˜²æŠ¤å’Œæ•°æ®ä¿æŠ¤
3. **ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½** - åˆç†çš„ç¼“å­˜å’Œå¼‚æ­¥å¤„ç†
4. **ä¾¿äºç»´æŠ¤** - æ¸…æ™°çš„æ¶æ„åˆ†å±‚å’Œå¼‚å¸¸å¤„ç†
5. **ç¡®ä¿å¯é æ€§** - å®Œå–„çš„æµ‹è¯•å’Œç›‘æ§ä½“ç³»

è®°ä½ï¼šæœ€ä½³å®è·µä¸æ˜¯æ•™æ¡ï¼Œè¦æ ¹æ®å…·ä½“é¡¹ç›®éœ€æ±‚çµæ´»åº”ç”¨ï¼Œåœ¨ä»£ç è´¨é‡ã€æ€§èƒ½å’Œå¼€å‘æ•ˆç‡ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹ã€‚