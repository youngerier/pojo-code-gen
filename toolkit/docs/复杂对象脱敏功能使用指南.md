# å¤æ‚å¯¹è±¡è„±æ•åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

å®¡è®¡ç»„ä»¶å®Œæ•´æ”¯æŒå¯¹å¤æ‚å¯¹è±¡å†…éƒ¨å±æ€§çš„è„±æ•å¤„ç†ï¼Œè§£å†³äº†å®é™…ä¸šåŠ¡ä¸­æ–¹æ³•å‚æ•°é€šå¸¸æ˜¯å¤æ‚ç±»å‹è€Œéç®€å•å­—ç¬¦ä¸²çš„é—®é¢˜ã€‚è¯¥åŠŸèƒ½é€šè¿‡æ³¨è§£å’Œè·¯å¾„é…ç½®ä¸¤ç§æ–¹å¼æä¾›çµæ´»çš„è„±æ•æ§åˆ¶ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. è‡ªåŠ¨åµŒå¥—è„±æ•
é€šè¿‡ `@SensitiveField` æ³¨è§£æ ‡è®°å¯¹è±¡å†…éƒ¨çš„æ•æ„Ÿå­—æ®µï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€’å½’å¤„ç†æ‰€æœ‰åµŒå¥—å¯¹è±¡ã€‚

### 2. å­—æ®µè·¯å¾„è„±æ•
é€šè¿‡ `fieldPaths` å±æ€§ç²¾ç¡®æŒ‡å®šéœ€è¦è„±æ•çš„å­—æ®µè·¯å¾„ï¼Œæ”¯æŒå¤šå±‚åµŒå¥—è®¿é—®ã€‚

### 3. æ··åˆè„±æ•ç­–ç•¥
åœ¨åŒä¸€ä¸ªå¤æ‚å¯¹è±¡ä¸­å¯ä»¥å¯¹ä¸åŒå­—æ®µä½¿ç”¨ä¸åŒçš„è„±æ•ç­–ç•¥ã€‚

## ğŸ“ ä½¿ç”¨æ–¹å¼

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨åµŒå¥—è„±æ•ï¼ˆæ¨èï¼‰

#### 1. åœ¨æ¨¡å‹ç±»ä¸­æ ‡è®°æ•æ„Ÿå­—æ®µ

```java
public class UserRegisterRequest {
    private String username;  // æ™®é€šå­—æ®µï¼Œä¸è„±æ•
    
    @SensitiveField(strategy = MaskStrategy.FULL)
    private String password;  // å¯†ç å®Œå…¨è„±æ•
    
    @SensitiveField(strategy = MaskStrategy.EMAIL)
    private String email;     // é‚®ç®±è„±æ•
    
    @SensitiveField(strategy = MaskStrategy.PHONE)
    private String phone;     // æ‰‹æœºå·è„±æ•
    
    @SensitiveField(enableNested = true)
    private UserProfile profile;  // åµŒå¥—å¯¹è±¡ï¼Œé€’å½’å¤„ç†
}

public class UserProfile {
    @SensitiveField(strategy = MaskStrategy.ID_CARD)
    private String idCard;    // èº«ä»½è¯è„±æ•
    
    @SensitiveField(strategy = MaskStrategy.BANK_CARD)
    private String bankCard;  // é“¶è¡Œå¡è„±æ•
    
    private String gender;    // æ™®é€šå­—æ®µï¼Œä¸è„±æ•
    
    @SensitiveField(enableNested = true)
    private Address address;  // ç»§ç»­åµŒå¥—
}
```

#### 2. åœ¨æ–¹æ³•ä¸Šä½¿ç”¨ `@SensitiveParam`

```java
@Auditable(operation = "ç”¨æˆ·æ³¨å†Œ")
public String registerUser(
    @SensitiveParam(
        autoNested = true,  // å¯ç”¨è‡ªåŠ¨åµŒå¥—è„±æ•
        description = "ç”¨æˆ·æ³¨å†Œè¯·æ±‚"
    ) UserRegisterRequest request) {
    // ä¸šåŠ¡é€»è¾‘
    return "æ³¨å†ŒæˆåŠŸ";
}
```

### æ–¹å¼äºŒï¼šå­—æ®µè·¯å¾„è„±æ•

å½“ä½ éœ€è¦ç²¾ç¡®æ§åˆ¶å“ªäº›å­—æ®µè¿›è¡Œè„±æ•æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å­—æ®µè·¯å¾„æ–¹å¼ï¼š

```java
@Auditable(operation = "æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ")
public void updateProfile(
    @SensitiveParam(
        fieldPaths = {
            "profile.realName",              // æ¡£æ¡ˆä¸­çš„çœŸå®å§“å
            "profile.idCard",                // æ¡£æ¡ˆä¸­çš„èº«ä»½è¯å·
            "profile.address.detailAddress", // åµŒå¥—å¯¹è±¡ä¸­çš„è¯¦ç»†åœ°å€
            "emergencyContact.contactPhone"  // ç´§æ€¥è”ç³»äººç”µè¯
        },
        strategy = MaskStrategy.DEFAULT,
        autoNested = false,  // ç¦ç”¨è‡ªåŠ¨è„±æ•ï¼Œåªå¤„ç†æŒ‡å®šå­—æ®µ
        description = "ç”¨æˆ·æ›´æ–°è¯·æ±‚"
    ) UserRegisterRequest updateRequest) {
    // ä¸šåŠ¡é€»è¾‘
}
```

### æ–¹å¼ä¸‰ï¼šæ··åˆè„±æ•ç­–ç•¥

åœ¨åŒä¸€ä¸ªå¯¹è±¡ä¸­å¯¹ä¸åŒå­—æ®µä½¿ç”¨ä¸åŒç­–ç•¥ï¼š

```java
@Auditable(operation = "å®åè®¤è¯")
public boolean performKYC(
    @SensitiveParam(
        fieldPaths = {"profile.bankCardNumber"},  // åªè„±æ•é“¶è¡Œå¡å·
        strategy = MaskStrategy.BANK_CARD,        // ä½¿ç”¨é“¶è¡Œå¡è„±æ•ç­–ç•¥
        autoNested = false,                       // ç¦ç”¨è‡ªåŠ¨è„±æ•
        description = "KYCéªŒè¯è¯·æ±‚"
    ) UserRegisterRequest kycRequest,
    
    @SensitiveParam(strategy = MaskStrategy.FULL)
    String verificationPassword) {  // éªŒè¯å¯†ç å®Œå…¨è„±æ•
    // ä¸šåŠ¡é€»è¾‘
    return true;
}
```

## ğŸ”§ è„±æ•ç­–ç•¥

æ”¯æŒçš„è„±æ•ç­–ç•¥åŒ…æ‹¬ï¼š

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨å­—æ®µ | ç¤ºä¾‹ |
|------|------|----------|------|
| `DEFAULT` | ä¿ç•™å‰2å2ä½ | é€šç”¨æ•æ„Ÿä¿¡æ¯ | `å¼ ä¸‰` â†’ `å¼ *ä¸‰`ï¼Œ`abcdefg` â†’ `ab***fg` |
| `FULL` | å®Œå…¨è„±æ• | å¯†ç ã€å¯†é’¥ | `password123` â†’ `****` |
| `EMAIL` | é‚®ç®±è„±æ• | é‚®ç®±åœ°å€ | `user@example.com` â†’ `u***@example.com` |
| `PHONE` | æ‰‹æœºå·è„±æ• | æ‰‹æœºå·ç  | `13812345678` â†’ `138****5678` |
| `BANK_CARD` | é“¶è¡Œå¡è„±æ• | é“¶è¡Œå¡å· | `6225881234567890` â†’ `**** **** **** 7890` |
| `ID_CARD` | èº«ä»½è¯è„±æ• | èº«ä»½è¯å· | `440301199001011234` â†’ `4403**********1234` |
| `CUSTOM` | è‡ªå®šä¹‰è„±æ• | ç‰¹æ®Šåœºæ™¯ | åŸºäºSpELè¡¨è¾¾å¼è‡ªå®šä¹‰ |

### è‡ªå®šä¹‰è„±æ•ç¤ºä¾‹

```java
@SensitiveField(
    strategy = MaskStrategy.CUSTOM,
    customExpression = "#value.length() > 20 ? #value.substring(0, 5) + '***[å·²è„±æ•]***' + #value.substring(#value.length()-5) : '***[å·²è„±æ•]***'",
    description = "ä¸ªäººç®€ä»‹"
)
private String biography;
```

## ğŸ“Š å®é™…è„±æ•æ•ˆæœ

### åŸå§‹æ•°æ®
```json
{
    "username": "zhangsan123",
    "password": "MySecretPassword123!",
    "email": "zhangsan@example.com",
    "phone": "13712345678",
    "profile": {
        "realName": "å¼ ä¸‰",
        "idCard": "440301199001011234",
        "bankCardNumber": "6225881234567890123",
        "address": {
            "detailAddress": "ç§‘æŠ€å›­å—åŒºæ·±å—å¤§é“9999å·ç§‘æŠ€å¤§å¦Aåº§1001å®¤",
            "longitude": 113.934782,
            "latitude": 22.547234
        }
    },
    "emergencyContact": {
        "contactName": "æå››",
        "contactPhone": "13987654321",
        "contactEmail": "lisi@example.com"
    }
}
```

### è„±æ•åæ•°æ®ï¼ˆä½¿ç”¨è‡ªåŠ¨åµŒå¥—è„±æ•ï¼‰
```json
{
    "username": "zhangsan123",
    "password": "****",
    "email": "z***@example.com",
    "phone": "137****5678",
    "profile": {
        "realName": "å¼ *ä¸‰",
        "idCard": "4403**********1234",
        "bankCardNumber": "**** **** **** 0123",
        "address": {
            "detailAddress": "ç§‘æŠ€****1å®¤",
            "longitude": "113.934***",
            "latitude": "22.547***"
        }
    },
    "emergencyContact": {
        "contactName": "æ*å››",
        "contactPhone": "139****4321",
        "contactEmail": "l***@example.com"
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. ç±»å­—æ®µç¼“å­˜
ç³»ç»Ÿä¼šç¼“å­˜å·²åˆ†æçš„ç±»ç»“æ„ï¼Œé¿å…é‡å¤åå°„ï¼š

```java
// ç¼“å­˜å·²åˆ†æçš„ç±»ç»“æ„ï¼Œé¿å…é‡å¤åå°„
private static final Map<Class<?>, List<SensitiveFieldInfo>> CLASS_FIELD_CACHE = new ConcurrentHashMap<>();
```

### 2. æ™ºèƒ½ç±»å‹æ£€æµ‹
åªå¯¹å¤æ‚å¯¹è±¡è¿›è¡ŒJSONåºåˆ—åŒ–å¤„ç†ï¼Œç®€å•ç±»å‹ç›´æ¥è„±æ•ï¼š

```java
// å¦‚æœæ˜¯åŸºæœ¬ç±»å‹æˆ–å­—ç¬¦ä¸²ï¼Œç›´æ¥è„±æ•
if (isSimpleType(data.getClass())) {
    return DataMaskingUtils.maskData(data, strategy, customExpression);
}
```

### 3. å¼‚æ­¥å¤„ç†
è„±æ•å¤„ç†åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸å½±å“ä¸»ä¸šåŠ¡æ€§èƒ½ï¼š

```java
@Auditable(
    operation = "æ‰¹é‡å¤„ç†",
    async = true,  // å¼‚æ­¥æ‰§è¡Œå®¡è®¡å’Œè„±æ•
    includeParameters = false  // å¤§æ‰¹é‡æ•°æ®ä¸è®°å½•å‚æ•°
)
```

## ğŸ›ï¸ é…ç½®é€‰é¡¹

### 1. å…¨å±€å¼€å…³
```java
@Auditable(
    enableParamAnnotations = true,  // å¯ç”¨å‚æ•°æ³¨è§£æ‰«æï¼ˆé»˜è®¤trueï¼‰
    includeParameters = true        // æ˜¯å¦è®°å½•å‚æ•°ï¼ˆé»˜è®¤trueï¼‰
)
```

### 2. å­—æ®µçº§åˆ«æ§åˆ¶
```java
@SensitiveField(
    strategy = MaskStrategy.DEFAULT,
    enableNested = true,    // æ˜¯å¦å¯ç”¨åµŒå¥—è„±æ•ï¼ˆé»˜è®¤trueï¼‰
    description = "å­—æ®µæè¿°"
)
```

### 3. å‚æ•°çº§åˆ«æ§åˆ¶
```java
@SensitiveParam(
    fieldPaths = {...},     // æŒ‡å®šå­—æ®µè·¯å¾„
    autoNested = true,      // è‡ªåŠ¨åµŒå¥—è„±æ•ï¼ˆé»˜è®¤trueï¼‰
    strategy = MaskStrategy.DEFAULT
)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ³¨è§£ä¼˜å…ˆçº§
å½“åŒæ—¶ä½¿ç”¨å¤šç§é…ç½®æ–¹å¼æ—¶ï¼Œä¼˜å…ˆçº§ä¸ºï¼š
1. **å‚æ•°æ³¨è§£** (`@SensitiveParam`)
2. **å­—æ®µæ³¨è§£** (`@SensitiveField`)
3. **å‚æ•°åç§°é…ç½®** (`sensitiveParamNames`)

### 2. åºåˆ—åŒ–å…¼å®¹æ€§
- ç³»ç»Ÿä½¿ç”¨Jacksonè¿›è¡ŒJSONåºåˆ—åŒ–
- æ”¯æŒå¾ªç¯å¼•ç”¨æ£€æµ‹
- å…¼å®¹å¸¸è§çš„åºåˆ—åŒ–æ³¨è§£

### 3. å†…å­˜å’Œæ€§èƒ½
- å¤§å¯¹è±¡å»ºè®®ä½¿ç”¨ `@IgnoreParam` è·³è¿‡è®°å½•
- å¤æ‚è„±æ•é€»è¾‘å»ºè®®ç¼“å­˜ç»“æœ
- å¼‚æ­¥æ¨¡å¼ä¸‹æ³¨æ„çº¿ç¨‹å®‰å…¨

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•ç¤ºä¾‹
```java
@Test
public void testComplexObjectMasking() {
    // åˆ›å»ºæµ‹è¯•æ•°æ®
    UserRegisterRequest request = createSampleUserRequest();
    
    // æ‰§è¡Œå¸¦è„±æ•çš„æ–¹æ³•
    String result = auditService.registerUserWithComplexObject(request);
    
    // éªŒè¯å®¡è®¡æ—¥å¿—ä¸­çš„è„±æ•æ•ˆæœ
    // å¯ä»¥é€šè¿‡AuditEventéªŒè¯è„±æ•æ˜¯å¦æ­£ç¡®
}
```

### é›†æˆæµ‹è¯•
```java
@SpringBootTest
public class ComplexObjectMaskingIntegrationTest {
    
    @Autowired
    private AuditExample auditExample;
    
    @Test
    public void testNestedObjectMasking() {
        UserRegisterRequest request = auditExample.createSampleUserRequest();
        auditExample.registerUserWithComplexObject(request);
        
        // éªŒè¯å®¡è®¡äº‹ä»¶è®°å½•
        // æ£€æŸ¥æ•æ„Ÿæ•°æ®æ˜¯å¦æ­£ç¡®è„±æ•
    }
}
```

## ğŸ“š æœ€ä½³å®è·µ

### 1. æ³¨è§£è®¾è®¡åŸåˆ™
- **æ˜ç¡®æ€§**ï¼šæ¸…æ¥šæ ‡è®°å“ªäº›å­—æ®µæ˜¯æ•æ„Ÿçš„
- **ä¸€è‡´æ€§**ï¼šåœ¨é¡¹ç›®ä¸­ç»Ÿä¸€ä½¿ç”¨ç›¸åŒçš„è„±æ•ç­–ç•¥
- **æ–‡æ¡£åŒ–**ï¼šä¸ºæ•æ„Ÿå­—æ®µæ·»åŠ æè¿°ä¿¡æ¯

### 2. è„±æ•ç­–ç•¥é€‰æ‹©
- **å¯†ç ç±»**ï¼šä½¿ç”¨ `FULL` ç­–ç•¥
- **è”ç³»æ–¹å¼**ï¼šä½¿ç”¨å¯¹åº”çš„ä¸“ç”¨ç­–ç•¥ï¼ˆ`EMAIL`ã€`PHONE`ï¼‰
- **èº«ä»½ä¿¡æ¯**ï¼šä½¿ç”¨ `ID_CARD`ã€`BANK_CARD` ç­–ç•¥
- **é€šç”¨æ•æ„Ÿä¿¡æ¯**ï¼šä½¿ç”¨ `DEFAULT` ç­–ç•¥

### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®
- **å¤§å¯¹è±¡å¤„ç†**ï¼šå¯¹äºè¶…å¤§å¯¹è±¡ï¼Œè€ƒè™‘ä½¿ç”¨ `@IgnoreParam`
- **å¼‚æ­¥å®¡è®¡**ï¼šé‡è¦ä½†éå®æ—¶çš„å®¡è®¡ä½¿ç”¨å¼‚æ­¥æ¨¡å¼
- **ç¼“å­˜åˆ©ç”¨**ï¼šå……åˆ†åˆ©ç”¨ç³»ç»Ÿçš„ç±»ç»“æ„ç¼“å­˜æœºåˆ¶

---

é€šè¿‡ä»¥ä¸ŠåŠŸèƒ½ï¼Œå®¡è®¡ç»„ä»¶å¯ä»¥å®Œç¾æ”¯æŒå¤æ‚ä¸šåŠ¡å¯¹è±¡çš„æ•æ„Ÿæ•°æ®è„±æ•ï¼Œæ—¢ä¿è¯äº†å®¡è®¡çš„å®Œæ•´æ€§ï¼Œåˆä¿æŠ¤äº†ç”¨æˆ·çš„éšç§å®‰å…¨ã€‚