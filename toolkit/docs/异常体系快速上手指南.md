# å¼‚å¸¸ä½“ç³»å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

## ğŸ† KISSåŸåˆ™ä¼˜åŒ–ï¼

æˆ‘ä»¬æŒ‰ç…§ **Keep It Simple and Stupid** åŸåˆ™å¯¹å¼‚å¸¸ä½“ç³»è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼š

âœ¨ **è‡ªåŠ¨å›½é™…åŒ–**: `ExceptionHandlerResult.system(exceptionCode)` è‡ªåŠ¨å¤„ç†å›½é™…åŒ–æ¶ˆæ¯  
âœ¨ **ä¸€è¡Œä»£ç **: æ— éœ€æ‰‹åŠ¨è°ƒç”¨ `ExceptionUtils.getLocalizedMessage()`  
âœ¨ **ç»Ÿä¸€ä½“éªŒ**: æ‰€æœ‰å¼‚å¸¸ç­–ç•¥éƒ½ä½¿ç”¨ç›¸åŒçš„ç®€åŒ–API  
âœ¨ **å¿«é€Ÿä¸Šæ‰‹**: æ–°æ‰‹ä¹Ÿèƒ½åœ¨å‡ åˆ†é’Ÿå†…æŒæ¡  

---

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹

### ç¬¬ä¸€æ­¥ï¼šç†è§£ä¸¤ç§å¼‚å¸¸ç±»å‹

```java
// ä¸šåŠ¡å¼‚å¸¸ - ç”¨æˆ·æ“ä½œå¯¼è‡´ï¼Œå¯é¢„æœŸ
BusinessException â†’ ç”¨æˆ·çœ‹å¾—æ‡‚çš„é”™è¯¯ï¼ˆå¦‚ï¼šç”¨æˆ·ä¸å­˜åœ¨ï¼‰

// ç³»ç»Ÿå¼‚å¸¸ - æŠ€æœ¯é—®é¢˜ï¼Œä¸å¯é¢„æœŸ  
SystemException â†’ æŠ€æœ¯é—®é¢˜ï¼ˆå¦‚ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥ï¼‰
```

### ç¬¬äºŒæ­¥ï¼šæŒæ¡å¼‚å¸¸æŠ›å‡ºæ–¹å¼

#### æ–¹å¼ä¸€ï¼šç›´æ¥æŠ›å‡ºï¼ˆæ¨èï¼‰
```java
// ä¸šåŠ¡å¼‚å¸¸
ExceptionUtils.throwBusiness(I18nCommonExceptionCode.USER_NOT_FOUND);
ExceptionUtils.throwBusiness(I18nCommonExceptionCode.DATA_ALREADY_EXISTS, "ç”¨æˆ·å");

// ç³»ç»Ÿå¼‚å¸¸
ExceptionUtils.throwSystem(I18nCommonExceptionCode.DATABASE_ERROR);
ExceptionUtils.throwSystem(I18nCommonExceptionCode.NETWORK_ERROR, cause);
```

#### æ–¹å¼äºŒï¼šæ¡ä»¶åˆ¤æ–­
```java
// æ¡ä»¶å¼‚å¸¸
ExceptionUtils.throwIf(user == null, I18nCommonExceptionCode.USER_NOT_FOUND);
ExceptionUtils.throwIf(email.exists(), I18nCommonExceptionCode.USER_ALREADY_EXISTS);

// ç³»ç»Ÿæ¡ä»¶å¼‚å¸¸
ExceptionUtils.throwSystemIf(connection == null, I18nCommonExceptionCode.DATABASE_ERROR);
```

#### æ–¹å¼ä¸‰ï¼šæ–­è¨€æ–¹å¼ï¼ˆæœ€ç®€æ´ï¼‰
```java
// å‚æ•°éªŒè¯
Assert.notNull(request, "request");
Assert.notBlank(username, "username");
Assert.validEmail(email);

// ä¸šåŠ¡æ–­è¨€
Assert.exists(user);           // ç­‰åŒäº throwIf(user == null, DATA_NOT_FOUND)
Assert.hasPermission(canAccess);
Assert.authenticated(isLoggedIn);
```

### ç¬¬ä¸‰æ­¥ï¼šäº†è§£å“åº”æ ¼å¼
æ‰€æœ‰å¼‚å¸¸éƒ½ä¼šè¢«è½¬æ¢ä¸ºç»Ÿä¸€çš„JSONæ ¼å¼ï¼š
```json
{
  "code": 1001,
  "message": "ç”¨æˆ·ä¸å­˜åœ¨",
  "data": null
}
```

**å›½é™…åŒ–æ”¯æŒ**ï¼š
- æ‰€æœ‰é”™è¯¯æ¶ˆæ¯éƒ½æ”¯æŒå›½é™…åŒ–
- ç³»ç»Ÿä¼šæ ¹æ®è¯·æ±‚å¤´çš„Accept-Languageè‡ªåŠ¨é€‰æ‹©è¯­è¨€
- æ”¯æŒå‚æ•°åŒ–æ¶ˆæ¯æ¨¡æ¿ï¼Œå¦‚ï¼š"å‚æ•° {0} è¶…å‡ºèŒƒå›´ [{1}, {2}]"

ä¾‹å¦‚ï¼ŒåŒä¸€ä¸ªé”™è¯¯åœ¨ä¸åŒè¯­è¨€ç¯å¢ƒä¸‹çš„æ˜¾ç¤ºï¼š
```json
// ä¸­æ–‡ç¯å¢ƒ
{ "code": 1001, "message": "ç”¨æˆ·ä¸å­˜åœ¨" }

// è‹±æ–‡ç¯å¢ƒ  
{ "code": 1001, "message": "User not found" }
```

### ç¬¬å››æ­¥ï¼šæŸ¥çœ‹è°ƒè¯•ä¿¡æ¯
æ¯ä¸ªå¼‚å¸¸éƒ½ä¼šç”ŸæˆtraceIdï¼Œä¾¿äºæ—¥å¿—å…³è”ï¼š
```
å¼‚å¸¸å¤„ç† [abc123def456] - è·¯å¾„: /api/users, é”™è¯¯ç : 1001, æ¶ˆæ¯: ç”¨æˆ·ä¸å­˜åœ¨
```

## ğŸ“š å¸¸ç”¨åœºæ™¯ç¤ºä¾‹

### ç”¨æˆ·ç®¡ç†åœºæ™¯
```java
@Service
public class UserService {
    
    public User getUserById(Long id) {
        // å‚æ•°éªŒè¯
        Assert.notNull(id, "id");
        
        User user = userRepository.findById(id);
        
        // ä¸šåŠ¡éªŒè¯
        Assert.exists(user);  // ç”¨æˆ·ä¸å­˜åœ¨æ—¶è‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸
        
        return user;
    }
    
    public void createUser(CreateUserRequest request) {
        // å‚æ•°éªŒè¯
        Assert.notNull(request, "request");
        Assert.notBlank(request.getUsername(), "username");
        Assert.validEmail(request.getEmail());
        
        // ä¸šåŠ¡éªŒè¯
        boolean userExists = userRepository.existsByUsername(request.getUsername());
        ExceptionUtils.throwIf(userExists, I18nCommonExceptionCode.USER_ALREADY_EXISTS);
        
        // åˆ›å»ºç”¨æˆ·...
    }
    
    public void deleteUser(Long id, User currentUser) {
        User user = getUserById(id);  // å¤ç”¨ä¸Šé¢çš„æ–¹æ³•
        
        // æƒé™æ£€æŸ¥
        Assert.hasPermission(canDeleteUser(currentUser, user));
        
        userRepository.delete(user);
    }
}
```

### å®‰å…¨è®¤è¯åœºæ™¯
```java
@Service
public class AuthService {
    
    public LoginResult login(String username, String password) {
        // å‚æ•°éªŒè¯
        Assert.notBlank(username, "username");
        Assert.notBlank(password, "password");
        
        User user = userRepository.findByUsername(username);
        Assert.exists(user);  // ç”¨æˆ·ä¸å­˜åœ¨
        
        // è´¦æˆ·çŠ¶æ€æ£€æŸ¥
        Assert.accountEnabled(!user.isDisabled());
        Assert.accountNotLocked(user.isLocked());
        
        // å¯†ç éªŒè¯
        Assert.correctPassword(passwordEncoder.matches(password, user.getPassword()));
        
        // ç”ŸæˆToken...
        return new LoginResult(token);
    }
    
    public void checkPermission(String resource, User user) {
        Assert.authenticated(user != null);
        
        boolean hasPermission = permissionService.hasPermission(user, resource);
        Assert.hasPermissionFor(hasPermission, resource);
    }
}
```

### æ•°æ®æ“ä½œåœºæ™¯
```java
@Service
public class OrderService {
    
    public void cancelOrder(Long orderId, User user) {
        Assert.notNull(orderId, "orderId");
        Assert.authenticated(user != null);
        
        Order order = orderRepository.findById(orderId);
        Assert.exists(order);
        
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        ExceptionUtils.throwIf(!order.getOwner().equals(user), 
                              I18nCommonExceptionCode.PERMISSION_DENIED);
        
        ExceptionUtils.throwIf(order.getStatus() != OrderStatus.PENDING,
                              I18nCommonExceptionCode.OPERATION_NOT_ALLOWED, "è®¢å•çŠ¶æ€ä¸å…è®¸å–æ¶ˆ");
        
        order.setStatus(OrderStatus.CANCELLED);
        orderRepository.save(order);
    }
}
```

## ğŸ› ï¸ è¿›é˜¶ä½¿ç”¨

### æ·»åŠ è‡ªå®šä¹‰å¼‚å¸¸ç 
```java
public enum OrderExceptionCode implements I18nExceptionCode {
    ORDER_NOT_FOUND("2001", "exception.order_not_found", "è®¢å•ä¸å­˜åœ¨"),
    ORDER_STATUS_INVALID("2002", "exception.order_status_invalid", "è®¢å•çŠ¶æ€æ— æ•ˆ"),
    ORDER_CANNOT_CANCEL("2003", "exception.order_cannot_cancel", "è®¢å•æ— æ³•å–æ¶ˆ");
    
    // å®ç°æ¥å£æ–¹æ³•...
}
```

### æ·»åŠ è‡ªå®šä¹‰å¼‚å¸¸ç­–ç•¥
```java
@Component
public class OrderExceptionStrategy implements ExceptionHandlerStrategy {
    
    @Override
    public boolean supports(Exception exception) {
        return exception instanceof OrderException;
    }
    
    @Override
    public ExceptionHandlerResult handle(Exception exception) {
        OrderException orderException = (OrderException) exception;
        
        // KISSåŸåˆ™ï¼šç›´æ¥ä½¿ç”¨ç®€åŒ–APIï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†å›½é™…åŒ–
        return ExceptionHandlerResult.business(orderException.getCode());
    }
    
    @Override
    public int getPriority() {
        return 12; // åœ¨ä¸šåŠ¡å¼‚å¸¸ä¹‹å‰å¤„ç†
    }
}
```

## ğŸ“‹ æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

```java
// 1. ä½¿ç”¨KISSåŸåˆ™çš„ç®€åŒ–APIï¼ˆæ¨èï¼ï¼‰
ExceptionUtils.throwBusiness(USER_NOT_FOUND);

// 2. å¸¦å‚æ•°çš„ç®€åŒ–API
ExceptionUtils.throwBusiness(PARAM_OUT_OF_RANGE, "age", "18", "65");

// 3. è‡ªå®šä¹‰å¼‚å¸¸ç­–ç•¥ä¸­ä½¿ç”¨ç®€åŒ–API
return ExceptionHandlerResult.business(exceptionCode);  // è‡ªåŠ¨å›½é™…åŒ–
return ExceptionHandlerResult.system(exceptionCode, args);  // å¸¦å‚æ•°

// 4. ä½¿ç”¨æ–­è¨€ç®€åŒ–ä»£ç 
Assert.notNull(user, "user");
Assert.exists(order);

// 5. æ¡ä»¶å¼‚å¸¸ä¸€è¡Œæå®š
ExceptionUtils.throwIf(condition, exceptionCode);
```

### âŒ é¿å…åšæ³•

```java
// 1. ä¸è¦ç›´æ¥throw new
throw new BusinessException(USER_NOT_FOUND);  // âŒ

// 2. ä¸è¦æš´éœ²æŠ€æœ¯ç»†èŠ‚
throw new RuntimeException("Connection refused: localhost:3306");  // âŒ

// 3. ä¸è¦ä½¿ç”¨é­”æ³•æ•°å­—
Response.error(1001, "é”™è¯¯");  // âŒ åº”è¯¥ä½¿ç”¨å¼‚å¸¸ç æšä¸¾

// 4. ä¸è¦æ‰‹åŠ¨å¤„ç†å›½é™…åŒ–ï¼ˆè¿åKISSåŸåˆ™ï¼‰
String message = ExceptionUtils.getLocalizedMessage(exceptionCode);  // âŒ
return ExceptionHandlerResult.business(code, message);  // âŒ

// åº”è¯¥ç›´æ¥ä½¿ç”¨ï¼š
return ExceptionHandlerResult.business(exceptionCode);  // âœ…
```

## ğŸ”§ è°ƒè¯•æŠ€å·§

### æ—¥å¿—æŸ¥çœ‹
```bash
# é€šè¿‡traceIdæŸ¥æ‰¾ç›¸å…³æ—¥å¿—
grep "abc123def456" application.log

# æŸ¥çœ‹ç‰¹å®šå¼‚å¸¸ç±»å‹
grep "BusinessException" application.log
```

### å¼€å‘ç¯å¢ƒè°ƒè¯•
```java
// åœ¨å¼€å‘ç¯å¢ƒå¯ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
if (log.isDebugEnabled()) {
    // å¼‚å¸¸è¯¦ç»†ä¿¡æ¯ä¼šè®°å½•åœ¨DEBUGæ—¥å¿—ä¸­
}
```

## ğŸ¯ å›¢é˜Ÿåä½œè§„èŒƒ

### é”™è¯¯ç åˆ†é…
- 1000-1099ï¼šé€šç”¨ä¸šåŠ¡é”™è¯¯
- 1100-1199ï¼šå‚æ•°éªŒè¯é”™è¯¯  
- 1200-1299ï¼šç”¨æˆ·ç›¸å…³é”™è¯¯
- 2000-2999ï¼šå„ä¸šåŠ¡æ¨¡å—è‡ªå®šä¹‰é”™è¯¯

### å‘½åè§„èŒƒ
```java
// é”™è¯¯ç å‘½åï¼šæ¨¡å—_æ“ä½œ_ç»“æœ
USER_LOGIN_FAILED("1203", "exception.user_login_failed", "ç”¨æˆ·ç™»å½•å¤±è´¥")
ORDER_CANCEL_NOT_ALLOWED("2003", "exception.order_cancel_not_allowed", "è®¢å•æ— æ³•å–æ¶ˆ")
```

### æ¶ˆæ¯è§„èŒƒ
```java
// âœ… ç”¨æˆ·å‹å¥½çš„æ¶ˆæ¯
"ç”¨æˆ·ä¸å­˜åœ¨"
"å¯†ç æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥6-20ä½å­—ç¬¦"

// âŒ æŠ€æœ¯æ€§æ¶ˆæ¯  
"User entity not found in database"
"Regex pattern validation failed"
```

## ğŸš€ ä»è¿™é‡Œå¼€å§‹

1. **å¤åˆ¶ç¤ºä¾‹ä»£ç ** - ç›´æ¥ä½¿ç”¨ä¸Šé¢çš„ç¤ºä¾‹
2. **è¿è¡Œæµ‹è¯•** - éªŒè¯å¼‚å¸¸å¤„ç†æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. **æŸ¥çœ‹æ—¥å¿—** - è§‚å¯ŸtraceIdå’Œé”™è¯¯ä¿¡æ¯æ ¼å¼
4. **æ·»åŠ è‡ªå®šä¹‰å¼‚å¸¸ç ** - æ ¹æ®ä¸šåŠ¡éœ€è¦æ‰©å±•
5. **åŸ¹è®­å›¢é˜Ÿ** - è®©æ‰€æœ‰å¼€å‘è€…ç»Ÿä¸€ä½¿ç”¨è¿™å¥—è§„èŒƒ

è®°ä½ï¼šè¿™å¥—å¼‚å¸¸ä½“ç³»çš„ç›®æ ‡æ˜¯è®©ä½ **ä¸“æ³¨ä¸šåŠ¡é€»è¾‘**ï¼Œè€Œä¸ç”¨æ‹…å¿ƒå¼‚å¸¸å¤„ç†çš„æŠ€æœ¯ç»†èŠ‚ï¼